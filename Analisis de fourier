import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from scipy.fft import fft, fftfreq
from scipy.signal import butter, filtfilt

# Ruta base
ruta = r"C:\Users\Angel\Downloads"

# Cargar datos
temperatura = pd.read_csv(ruta + r"\temperatura.csv")
humedad = pd.read_csv(ruta + r"\humedad.csv")
viento = pd.read_csv(ruta + r"\viento.csv")

# Parámetros
intervalo = 5  # segundos
fs = 1 / intervalo  # 0.2 Hz

temperatura["Tiempo"] = temperatura.index * intervalo
humedad["Tiempo"] = humedad.index * intervalo
viento["Tiempo"] = viento.index * intervalo

# Filtros
def filtro_pasa_bajas(senal, fc=0.06, orden=2):
    b, a = butter(orden, fc, btype='low')
    return filtfilt(b, a, senal)

def filtro_pasa_bandas(senal, f_low=0.01, f_high=0.09, orden=2):
    b, a = butter(orden, [f_low, f_high], btype='band')
    return filtfilt(b, a, senal)

# FFT
def calcular_fft(senal, fs):
    N = len(senal)
    frecs = fftfreq(N, d=1/fs)
    fft_vals = fft(senal)
    magnitud = np.abs(fft_vals) / N
    return frecs[:N//2], magnitud[:N//2]

# Graficar
def graficar_fft_comparativo(df, columna, nombre_sensor, unidad):
    original = df[columna]
    pasa_bajas = filtro_pasa_bajas(original)
    pasa_bandas = filtro_pasa_bandas(original)

    f1, m1 = calcular_fft(original, fs)
    f2, m2 = calcular_fft(pasa_bajas, fs)
    f3, m3 = calcular_fft(pasa_bandas, fs)

    plt.figure(figsize=(10, 5))
    plt.plot(f1, m1, label="Original", color='blue', alpha=0.7)
    plt.plot(f2, m2, label="Pasa Bajas", color='red', linestyle='--')
    plt.plot(f3, m3, label="Pasa Bandas", color='green', linestyle=':')
    plt.title(f"{nombre_sensor} - Espectro de Frecuencia")
    plt.xlabel("Frecuencia (Hz)")
    plt.ylabel("Magnitud")
    plt.grid(True)
    plt.legend()
    plt.tight_layout()
    plt.show()

# Ejecutar
graficar_fft_comparativo(temperatura, "Temperatura_C", "Temperatura", "°C")
graficar_fft_comparativo(humedad, "Humedad_Relativa_%", "Humedad", "% HR")
graficar_fft_comparativo(viento, "Velocidad_Viento_mps", "Viento", "m/s")
